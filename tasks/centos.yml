---
- name: CentOS | copy rabbitmq repo setup script
  ansible.builtin.copy:
    src: "{{ ansible_os_family | lower }}{{ rabbitmq_repo.file }}"
    dest: "{{ rabbitmq_repo.file }}"
    mode: "0755"

- name: CentOS | set rabbitmq repo
  ansible.builtin.command: "{{ rabbitmq_repo.file }}"
  become: true

- name: CentOS | copy erlang repo file
  ansible.builtin.copy:
    src: "{{ ansible_os_family | lower }}{{ rabbitmq_erlang_repo }}"
    dest: "{{ rabbitmq_erlang_repo }}"
    mode: "0644"
  become: true

- name: CentOS | import repo gpg keys
  ansible.builtin.command: >-
    rpm --import {{ item }}
  become: true
  loop: "{{ rabbitmq_repo_gpg_keys }}"

- name: CentOS | install packages
  ansible.builtin.package:
    name: "{{ item }}"
    state: "{{ pkg_state }}"
  register: _pkg
  until: not _pkg.failed
  retries: 3
  delay: 3
  become: true
  loop: "{{ packages }}"

- name: CentOS | template rabbitmq-env.conf
  ansible.builtin.template:
    dest: "{{ item.dest }}"
    src: "{{ ansible_os_family | lower }}{{ item.dest + '.j2' }}"
    owner: "rabbitmq"
    group: "rabbitmq"
    mode: "0644"
  loop: "{{ service_conf }}"
  become: true
  changed_when: true
  notify:
    - systemctl restart service

- name: CentOS | force handlers to run
  ansible.builtin.meta: flush_handlers
...
